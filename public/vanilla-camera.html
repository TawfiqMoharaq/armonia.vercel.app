<button id="startBtn">تشغيل الكاميرا</button>

<script type="module">
  const MODEL_CANDIDATES = [
    "https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/latest/pose_landmarker_lite.task",
    "https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float32/latest/pose_landmarker_lite.task",
    "https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_full/float32/latest/pose_landmarker_full.task",
  ];
  const WASM_BASE = "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.22/wasm";

  const video   = document.getElementById("video");
  const canvas  = document.getElementById("canvas");
  const ctx     = canvas.getContext("2d");
  const errBox  = document.getElementById("err");
  const repsEl  = document.getElementById("reps");
  const kaEl    = document.getElementById("ka");
  const baEl    = document.getElementById("ba");
  const startBtn= document.getElementById("startBtn");

  let landmarker = null, raf = 0, wasDown = false, reps = 0;

  function showError(msg){ errBox.style.display="flex"; errBox.textContent = String(msg); }
  function hideError(){ errBox.style.display="none"; }

  async function getStream(){
    const trials = [
      { video:{ facingMode:"user", width:{ideal:960}, height:{ideal:720} }, audio:false },
      { video:true, audio:false },
    ];
    let last;
    for (const c of trials) { try { return await navigator.mediaDevices.getUserMedia(c); } catch(e){ last=e; } }
    throw last || new Error("تعذر تشغيل الكاميرا.");
  }

  function loop(){
    if (video.readyState < 2) { raf = requestAnimationFrame(loop); return; }

    const now = performance.now();
    const out = landmarker.detectForVideo(video, now);

    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    if (out.landmarks.length){
      const lms = out.landmarks[0];
      ctx.fillStyle="#18A4B8";
      for(const p of lms) if ((p.visibility??0) > 0.65)
        ctx.fillRect(p.x*canvas.width-2, p.y*canvas.height-2, 4,4);

      // حساب بسيط للزوايا/العد ممكن تضيفه هنا (تركته مختصرًا الآن)
    }
    raf = requestAnimationFrame(loop);
  }

  startBtn.addEventListener("click", async () => {
    startBtn.disabled = true;

    try {
      // ✅ الاستيراد هنا — لو فشل بنعرض رسالة واضحة
      const vision = await import("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.22");
      const { FilesetResolver, PoseLandmarker } = vision;

      if (!navigator.mediaDevices?.getUserMedia) throw new Error("المتصفح لا يدعم getUserMedia.");
      if (!window.isSecureContext) throw new Error("الصفحة ليست HTTPS.");

      const fileset = await FilesetResolver.forVisionTasks(WASM_BASE);

      // جرّب GPU→CPU وكل النماذج
      let lastErr=null;
      for (const delegate of ["GPU","CPU"]) {
        for (const url of MODEL_CANDIDATES) {
          try {
            landmarker = await PoseLandmarker.createFromOptions(fileset, {
              baseOptions: { modelAssetPath: url },
              runningMode: "VIDEO",
              numPoses: 1,
              delegate
            });
            lastErr=null; break;
          } catch(e){ lastErr=e; }
        }
        if (!lastErr) break;
      }
      if (!landmarker) throw lastErr || new Error("تعذر تحميل نموذج التتبّع.");

      const stream = await getStream();
      video.srcObject = stream;
      video.muted = true; video.playsInline = true; // iOS
      await video.play().catch(()=>{});
      await new Promise(res => {
        if (video.readyState >= 2) return res();
        video.onloadeddata = () => res();
      });

      // اضبط أبعاد الكانفس
      if (video.videoWidth && video.videoHeight) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
      }

      hideError();
      loop();
    } catch (e) {
      console.error(e);
      showError(e?.message || e);
      startBtn.disabled = false;
    }
  });

  // تنظيف
  window.addEventListener("beforeunload", ()=>{
    cancelAnimationFrame(raf);
    const s = video.srcObject; if (s) s.getTracks().forEach(t=>t.stop());
    landmarker?.close?.();
  });
</script>
