<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Armonia â€“ ÙƒØ§Ù…ÙŠØ±Ø§ + GIF</title>

  <style>
    :root {
      --card-h: 460px;
      --max-w: 1100px;
      --gap: 16px;
      --bg: #111;
      --fg: #fff;
      --accent: #0a84ff;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      min-height: 100vh;
      display: block;            /* Ù…Ù‡Ù…: Ù„Ø§ Ù†Ø¬Ø¹Ù„Ù‡Ø§ flex */
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: min(92vw, var(--max-w));
      margin: 18px auto 0;
      gap: 10px;
    }
    .btn {
      appearance: none;
      border: 0;
      padding: 10px 16px;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      color: #fff;
      background: var(--accent);
    }
    .btn.secondary { background: #444; }
    #info {
      font-size: 14px;
      opacity: 0.9;
    }
    #container {
      width: min(92vw, var(--max-w));
      margin: 12px auto 24px;
      display: grid;
      grid-template-columns: 1fr 1fr;   /* GIF ÙŠØ³Ø§Ø± | ÙƒØ§Ù…ÙŠØ±Ø§ ÙŠÙ…ÙŠÙ† */
      gap: var(--gap);
    }
    .card {
      width: 100%;
      height: var(--card-h);
      background: #000;
      border-radius: 20px;
      overflow: hidden;
      position: relative;
      box-shadow: 0 10px 30px rgb(0 0 0 / 0.25);
    }
    /* â€”â€” ØµÙˆØ±Ø© Ø§Ù„Ù€GIF â€”â€” */
    #demo {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: #000;
      display: block;
    }
    /* â€”â€” Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ â€”â€” */
    #video {
      display: none;              /* Ù†Ø®ÙÙŠ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆÙ†Ø±Ø³Ù…Ù‡ Ø¹Ù„Ù‰ Ø§Ù„ÙƒØ§Ù†ÙØ³ */
    }
    #canvas {
      width: 100%;
      height: 100%;
      display: block;
      background: #000;
    }
    /* Ø´Ø§Ø±Ø© ØµØºÙŠØ±Ø© Ø£Ø¹Ù„Ù‰ ÙŠÙ…ÙŠÙ† Ø§Ù„ÙƒØ§Ù†ÙØ³ Ù„Ù„Ù‚ÙŠÙÙ… */
    .hud {
      position: absolute;
      top: 10px;
      right: 12px;
      display: flex;
      gap: 8px;
      padding: 6px 10px;
      background: rgb(0 0 0 / 0.45);
      border-radius: 10px;
      font-size: 13px;
      backdrop-filter: blur(4px);
    }
    .hud b { font-weight: 700; }
    .warning {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: 12px;
      padding: 8px 14px;
      border-radius: 14px;
      background: rgba(220, 38, 38, .88);
      color: #fff;
      font-weight: 700;
      box-shadow: 0 8px 20px rgba(0,0,0,.35);
      display: none;
    }
    @media (max-width: 900px) {
      #container { grid-template-columns: 1fr; }
      .hud { right: 10px; }
    }
  </style>
</head>
<body>

  <header>
    <div id="info">Ø¬Ø§Ù‡Ø² âœ… â€” Ø´ØºÙ‘Ù„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ù„ØªØªØ¨Ù‘Ø¹</div>
    <div>
      <button id="btnStart" class="btn">ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
      <button id="btnStop"  class="btn secondary" style="display:none;">Ø¥ÙŠÙ‚Ø§Ù</button>
    </div>
  </header>

  <main id="container">
    <!-- ÙŠØ³Ø§Ø±: GIF -->
    <div class="card">
      <img id="demo" src="/gifs/squat.gif" alt="Bodyweight Squat GIF"
           onerror="this.style.display='none'"/>
    </div>

    <!-- ÙŠÙ…ÙŠÙ†: Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¹Ù„Ù‰ Ø§Ù„ÙƒØ§Ù†ÙØ³ -->
    <div class="card">
      <video id="video" autoplay playsinline muted></video>
      <canvas id="canvas"></canvas>

      <div class="hud" id="hud" style="display:none;">
        <span>Reps: <b id="reps">0</b></span>
        <span>| Knee: <b id="knee">â€”</b>Â°</span>
        <span>| Back: <b id="back">â€”</b>Â°</span>
      </div>
      <div class="warning" id="warn">Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ø³ØªÙ‚Ø§Ù…Ø© Ø¸Ù‡Ø±Ùƒ!</div>
    </div>
  </main>

  <!-- âœ… Vision bundle Ù…Ù† unpkg (Ø£ÙØ¶Ù„ Ù…Ù† jsDelivr ÙÙŠ Ø­Ø§Ù„ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ) -->
  <script src="https://unpkg.com/@mediapipe/tasks-vision@0.10.22/vision_bundle.js"
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script>
    // Ø¹Ù†Ø§ØµØ± DOM
    const infoEl  = document.getElementById('info');
    const btnStart= document.getElementById('btnStart');
    const btnStop = document.getElementById('btnStop');
    const video   = document.getElementById('video');
    const canvas  = document.getElementById('canvas');
    const ctx     = canvas.getContext('2d');
    const hud     = document.getElementById('hud');
    const repsEl  = document.getElementById('reps');
    const kneeEl  = document.getElementById('knee');
    const backEl  = document.getElementById('back');
    const warnEl  = document.getElementById('warn');

    // Mediapipe
    let landmarker = null;
    let rafId = 0;

    // Ø¹Ø¯Ù‘Ø§Ø¯ Ø§Ù„Ø³ÙƒÙˆØ§Øª
    let reps = 0, wasDown = false;
    const KNEE_UP = 160, KNEE_DOWN_MIN = 70, KNEE_DOWN_MAX = 100, BACK_SAFE = 150;

    function setInfo(t){ infoEl.textContent = t; }

    // Ø­Ø³Ø§Ø¨ Ø²Ø§ÙˆÙŠØ© 2D
    function angle(a, b, c){
      if (!a || !b || !c) return null;
      const abx=a.x-b.x, aby=a.y-b.y, cbx=c.x-b.x, cby=c.y-b.y;
      const dot = abx*cbx + aby*cby;
      const mab = Math.hypot(abx, aby), mcb = Math.hypot(cbx, cby);
      if (!mab || !mcb) return null;
      const cos = Math.min(Math.max(dot / (mab*mcb), -1), 1);
      return Math.acos(cos) * 180/Math.PI;
    }

    function pickLeg(lms){
      // Mediapipe indices: L(11,23,25,27) R(12,24,26,28)
      const L={shoulder:11, hip:23, knee:25, ankle:27};
      const R={shoulder:12, hip:24, knee:26, ankle:28};
      const vis = i => lms[i]?.visibility ?? 0;
      const score = s => vis(s.hip) + vis(s.knee) + vis(s.ankle);
      return score(L) >= score(R) ? L : R;
    }

    function syncCanvasSize(){
      if (!video.videoWidth || !video.videoHeight) return;
      if (canvas.width !== video.videoWidth)   canvas.width  = video.videoWidth;
      if (canvas.height !== video.videoHeight) canvas.height = video.videoHeight;
    }

    function drawLoop(){
      rafId = requestAnimationFrame(drawLoop);
      if (!landmarker || video.readyState < 2) return;

      syncCanvasSize();

      // Ø§Ø±Ø³Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø£ÙˆÙ„Ù‹Ø§ (Ù…Ø±Ø¢Ø© Ù„Ù„Ù€selfie)
      ctx.save();
      ctx.scale(-1, 1);
      ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
      ctx.restore();

      const now = performance.now();
      const out = landmarker.detectForVideo(video, now);

      if (out.landmarks.length){
        hud.style.display = 'flex';

        const lms = out.landmarks[0];       // normalized [0..1]
        // Ø§Ø±Ø³Ù… Ù†Ù‚Ø§Ø· ÙˆØ§Ø¶Ø­Ø©
        ctx.fillStyle = "#18A4B8";
        for (const p of lms){
          if ((p.visibility ?? 0) > 0.55){
            ctx.beginPath();
            ctx.arc(p.x*canvas.width, p.y*canvas.height, 4, 0, Math.PI*2);
            ctx.fill();
          }
        }

        // Ø­Ø³Ø§Ø¨ Ø²ÙˆØ§ÙŠØ§ Ø§Ù„Ø±ÙƒØ¨Ø© ÙˆØ§Ù„Ø¸Ù‡Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø§Ù‚/Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ø£ÙØ¶Ù„
        const side = pickLeg(lms);
        const hip = lms[side.hip], knee = lms[side.knee], ankle = lms[side.ankle], shoulder = lms[side.shoulder];

        const kneeAng = angle(hip, knee, ankle);
        const backAng = angle(shoulder, hip, knee);

        if (kneeAng != null){
          kneeEl.textContent = Math.round(kneeAng);
          // Ø¹Ø¯Ù‘ Ø§Ù„Ø³ÙƒÙˆØ§Øª
          if (kneeAng >= KNEE_DOWN_MIN && kneeAng <= KNEE_DOWN_MAX) wasDown = true;
          if (kneeAng >= KNEE_UP && wasDown){
            wasDown = false;
            reps++;
            repsEl.textContent = reps;
          }
        } else {
          kneeEl.textContent = 'â€”';
        }

        if (backAng != null){
          backEl.textContent = Math.round(backAng);
          const bad = backAng < BACK_SAFE;
          warnEl.style.display = bad ? 'block' : 'none';
        } else {
          backEl.textContent = 'â€”';
          warnEl.style.display = 'none';
        }
      } else {
        hud.style.display = 'none';
        warnEl.style.display = 'none';
        ctx.fillStyle = "#fff";
        ctx.font = "14px sans-serif";
        ctx.fillText("Ø§Ù‚ØªØ±Ø¨ Ù…Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆÙˆÙÙ‘Ø± Ø¥Ø¶Ø§Ø¡Ø© Ø£ÙØ¶Ù„.", 16, 28);
      }
    }

    async function initModel(){
      try{
        setInfo("Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ Mediapipeâ€¦");
        const fileset = await FilesetResolver.forVisionTasks(
          "https://unpkg.com/@mediapipe/tasks-vision@0.10.22/wasm"
        );
        landmarker = await PoseLandmarker.createFromOptions(fileset, {
          baseOptions: {
            modelAssetPath:
              "https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/latest/pose_landmarker_lite.task"
          },
          runningMode: "VIDEO",
          numPoses: 1
        });
        setInfo("âœ… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¬Ø§Ù‡Ø² â€” Ø§Ø¶ØºØ· ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§");
      }catch(e){
        console.error(e);
        setInfo("âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ Mediapipe. ØªØ­Ù‚Ù‘Ù‚ Ù…Ù† Ø§Ù„Ø´Ø¨ÙƒØ© Ø«Ù… Ø­Ø¯Ù‘Ø« Ø§Ù„ØµÙØ­Ø©.");
      }
    }

    async function startCamera(){
      try{
        setInfo("Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§â€¦");
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "user", width: {ideal: 1280}, height: {ideal: 720} },
          audio: false
        });
        video.srcObject = stream;
        await video.play();
        video.addEventListener("resize", syncCanvasSize);
        syncCanvasSize();

        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·
        reps = 0; wasDown = false;
        repsEl.textContent = '0'; kneeEl.textContent = 'â€”'; backEl.textContent = 'â€”';

        drawLoop();
        btnStart.style.display = 'none';
        btnStop.style.display  = 'inline-block';
        setInfo("ğŸ“¹ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªØ¹Ù…Ù„ â€” ØªÙ… Ø¨Ø§Ù„ØªØªØ¨Ù‘Ø¹!");
      }catch(e){
        console.error(e);
        setInfo("âŒ ØªÙ… Ø±ÙØ¶ Ø¥Ø°Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø£Ùˆ ØªØ¹Ø°Ø± ÙØªØ­Ù‡Ø§. Ø§Ø³Ù…Ø­ Ù…Ù† Ø§Ù„Ù‚ÙÙ„ Ø¨Ø¬ÙˆØ§Ø± Ø§Ù„Ø±Ø§Ø¨Ø· Ø«Ù… Ø­Ø¯Ù‘Ø«.");
      }
    }

    function stopCamera(){
      cancelAnimationFrame(rafId);
      rafId = 0;
      const ms = video.srcObject;
      if (ms) {
        ms.getTracks().forEach(t => t.stop());
        video.srcObject = null;
      }
      hud.style.display = 'none';
      warnEl.style.display = 'none';
      btnStart.style.display = 'inline-block';
      btnStop.style.display  = 'none';
      setInfo("ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. ÙŠÙ…ÙƒÙ†Ùƒ ØªØ´ØºÙŠÙ„Ù‡Ø§ Ù…Ø¬Ø¯Ø¯Ù‹Ø§.");
      // Ø§Ù…Ø³Ø­ Ø§Ù„ÙƒØ§Ù†ÙØ³
      ctx.clearRect(0,0,canvas.width, canvas.height);
    }

    btnStart.addEventListener('click', startCamera);
    btnStop .addEventListener('click', stopCamera);

    // Ø§Ø¨Ø¯Ø£ Ø¨ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù…Ø¨Ø§Ø´Ø±Ø©
    initModel();
  </script>
</body>
</html>
