<script>
let video = document.getElementById("video");
let canvas = document.getElementById("canvas");
let ctx = canvas.getContext("2d");
let info = document.getElementById("info");
let landmarker = null;
let rafId = 0;
let reps = 0;
let wasDown = false;

const WASM_BASE = "https://unpkg.com/@mediapipe/tasks-vision@0.10.22/wasm";
const KNEE_UP = 160, KNEE_DOWN_MIN = 70, KNEE_DOWN_MAX = 100;

// 2D angle
function angle(a, b, c) {
  if (!a || !b || !c) return null;
  const abx = a.x - b.x, aby = a.y - b.y;
  const cbx = c.x - b.x, cby = c.y - b.y;
  const dot = abx*cbx + aby*cby;
  const mab = Math.hypot(abx, aby);
  const mcb = Math.hypot(cbx, cby);
  if (!mab || !mcb) return null;
  const cos = Math.min(Math.max(dot / (mab*mcb), -1), 1);
  return Math.acos(cos) * 180 / Math.PI;
}

function pickLeg(lms){
  // indices Ù…Ù† Mediapipe: L(11,23,25,27) R(12,24,26,28)
  const L={shoulder:11,hip:23,knee:25,ankle:27}, R={shoulder:12,hip:24,knee:26,ankle:28};
  const vis = i => lms[i]?.visibility ?? 0;
  const score = side => (vis(side.hip) + vis(side.knee) + vis(side.ankle));
  return score(L) >= score(R) ? L : R;
}

function syncCanvasSize(){
  // Ù„Ùˆ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„ ØªØºÙŠØ±Øª Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© ØªÙØ¹Ù„Ù‡Ø§) Ù†Ø²Ø¨Ø· Ø§Ù„ÙƒØ§Ù†ÙØ³
  const w = video.videoWidth || 640;
  const h = video.videoHeight || 480;
  if (canvas.width !== w) canvas.width = w;
  if (canvas.height !== h) canvas.height = h;
}

async function initModel(){
  info.textContent = "Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ ØªØªØ¨Ù‘Ø¹ Ø§Ù„Ø¬Ø³Ù…â€¦";
  const fileset = await FilesetResolver.forVisionTasks(WASM_BASE);
  landmarker = await PoseLandmarker.createFromOptions(fileset, {
    baseOptions: { modelAssetPath:
      "https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/latest/pose_landmarker_lite.task"
    },
    runningMode: "VIDEO",
    numPoses: 1
  });
  info.textContent = "âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ â€” Ø§Ø¶ØºØ· ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§";
}

async function startCamera(){
  info.textContent = "Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§â€¦";
  try{
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "user", width: {ideal: 1280}, height: {ideal: 720} },
      audio: false
    });
    video.srcObject = stream;
    video.onloadedmetadata = () => {
      syncCanvasSize();
      info.textContent = "Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªØ¹Ù…Ù„ â€” ØªÙ… Ø¨Ø§Ù„ØªØªØ¨Ù‘Ø¹! ğŸ“·";
      video.play();
      // Ø§Ø³Ù…Ø¹ Ø£ÙŠ ØªØºÙŠÙŠØ± Ø£Ø¨Ø¹Ø§Ø¯ ÙŠØ­Ø¯Ø« Ù„Ø§Ø­Ù‚Ù‹Ø§
      video.addEventListener("resize", syncCanvasSize);
      loop();
    };
  }catch(e){
    info.textContent = "âŒ Ø±ÙÙØ¶ Ø¥Ø°Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. Ø§Ø³Ù…Ø­ Ù…Ù† Ø§Ù„Ù‚ÙÙ„ Ø¨Ø¬ÙˆØ§Ø± Ø§Ù„Ø±Ø§Ø¨Ø· Ø«Ù… Ø­Ø¯Ù‘Ø« Ø§Ù„ØµÙØ­Ø©.";
  }
}

function drawLandmarks(lms){
  // Ù†Ù‚Ø§Ø·
  ctx.fillStyle = "#18A4B8";
  for (const p of lms){
    if ((p.visibility ?? 0) > 0.55) {
      ctx.beginPath();
      ctx.arc(p.x * canvas.width, p.y * canvas.height, 4, 0, Math.PI*2);
      ctx.fill();
    }
  }
}

function loop(){
  rafId = requestAnimationFrame(loop);
  if (!landmarker || video.readyState < 2) return;

  // 1) Ø§Ø±Ø³Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø£ÙˆÙ„Ù‹Ø§ (Ù…Ø¹ Ù‚Ù„Ø¨ Ø£ÙÙ‚ÙŠ Ù„Ø¹Ø±Ø¶ Selfie)
  syncCanvasSize();
  ctx.save();
  ctx.scale(-1, 1);                      // mirror
  ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
  ctx.restore();

  // 2) Ø§Ù„ØªØªØ¨Ù‘Ø¹
  const now = performance.now();
  const out = landmarker.detectForVideo(video, now);

  // 3) Ù„Ùˆ ÙÙŠÙ‡ Ù†Ù‚Ø§Ø·ØŒ Ø§Ø±Ø³Ù…Ù‡Ø§ ÙˆØ§Ø­Ø³Ø¨ Ø§Ù„Ø²ÙˆØ§ÙŠØ§ ÙˆØ§Ù„Ø¹Ø¯Ù‘
  if (out.landmarks.length){
    const lmsNorm = out.landmarks[0];

    // Ù†Ù‚Ø§Ø· lmsNorm.x/y Ù‡ÙŠ normalized (0..1) â€” Ø­ÙˆÙ‘Ù„Ù‡Ø§ Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø¨ÙƒØ³Ù„ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø±Ø³Ù…
    drawLandmarks(lmsNorm);

    const side = pickLeg(lmsNorm);
    const hip = lmsNorm[side.hip], knee = lmsNorm[side.knee], ankle = lmsNorm[side.ankle];

    const kAng = angle(
      {x: hip.x, y: hip.y},
      {x: knee.x, y: knee.y},
      {x: ankle.x, y: ankle.y}
    );

    // Ù†ØµÙˆØµ ØªØ´Ø®ÙŠØµÙŠØ©
    ctx.fillStyle = "white";
    ctx.font = "16px sans-serif";
    ctx.fillText(`Knee: ${kAng ? Math.round(kAng) : "â€”"}Â°`, 16, 28);
    ctx.fillText(`Reps: ${reps}`, 16, 50);

    // Ø¹Ø¯Ù‘ Ø§Ù„Ø³ÙƒÙˆØ§Øª
    if (kAng != null) {
      if (kAng <= KNEE_DOWN_MAX) wasDown = true;
      if (kAng >= KNEE_UP && wasDown) {
        reps++;
        wasDown = false;
      }
    }
  } else {
    // Ù„Ùˆ Ù…Ø§ ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø¬Ø³Ù…ØŒ Ø£Ø¹Ø±Ø¶ ØªÙ„Ù…ÙŠØ­
    ctx.fillStyle = "white";
    ctx.font = "16px sans-serif";
    ctx.fillText("Ø§Ù‚ØªØ±Ø¨ Ù…Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆÙˆÙÙ‘Ø± Ø¥Ø¶Ø§Ø¡Ø© Ø£ÙØ¶Ù„.", 16, 28);
  }
}

document.getElementById("btnStart").addEventListener("click", startCamera);
initModel();
</script>
