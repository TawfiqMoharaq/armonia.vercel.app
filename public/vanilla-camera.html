<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>Camera Squat Tracking</title>

<style>
  body {
    background: #111;
    margin: 0;
    color: white;
    font-family: sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
  }
  #container {
    width: 90vw;
    max-width: 1100px;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
  }
  video, canvas {
    width: 100%;
    height: 450px;
    background: black;
    border-radius: 20px;
  }
  #btnStart {
    position: absolute;
    top: 15px;
    left: 15px;
    background: #0078ff;
    color: white;
    padding: 10px 18px;
    border-radius: 12px;
    cursor: pointer;
    font-weight: bold;
    border: none;
  }
  #info {
    margin-top: 10px;
    white-space: pre-line;
    font-size: 16px;
  }
</style>

</head>
<body>

<button id="btnStart">ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>

<div id="container">
  <video id="video" autoplay playsinline muted></video>
  <canvas id="canvas"></canvas>
</div>

<div id="info">Ø¬Ø§Ù‡Ø² âœ…</div>

<!-- âœ… ØªØ­Ù…ÙŠÙ„ Mediapipe Vision bundle Ù…Ù† unpkg Ø¨Ø³Ø¨Ø¨ Ù…Ø´Ø§ÙƒÙ„ jsDelivr -->
<script src="https://unpkg.com/@mediapipe/tasks-vision@0.10.22/vision_bundle.js"
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
let video = document.getElementById("video");
let canvas = document.getElementById("canvas");
let ctx = canvas.getContext("2d");
let info = document.getElementById("info");
let landmarker = null;
let animationFrame;
let reps = 0;
let wasDown = false;

const WASM_BASE = "https://unpkg.com/@mediapipe/tasks-vision@0.10.22/wasm";

// âœ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ø²ÙˆØ§ÙŠØ§
function angle(a, b, c) {
  const ab = {x: a.x-b.x, y:a.y-b.y};
  const cb = {x: c.x-b.x, y:c.y-b.y};
  const dot = ab.x*cb.x + ab.y*cb.y;
  const magAB = Math.hypot(ab.x, ab.y);
  const magCB = Math.hypot(cb.x, cb.y);
  if (!magAB || !magCB) return 0;
  return Math.acos(dot / (magAB * magCB)) * (180/Math.PI);
}

async function initModel() {
  info.innerText = "Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ ØªØªØ¨Ø¹ Ø§Ù„Ø¬Ø³Ù…...";
  const fileset = await FilesetResolver.forVisionTasks(WASM_BASE);
  landmarker = await PoseLandmarker.createFromOptions(fileset, {
    baseOptions: {
      modelAssetPath:
        "https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/latest/pose_landmarker_lite.task"
    },
    runningMode: "VIDEO",
    numPoses: 1
  });

  info.innerText = "âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ â€” Ø´ØºÙ‘Ù„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§";
}

async function startCamera() {
  info.innerText = "Ø·Ù„Ø¨ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...";
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: {facingMode:"user", width:1280, height:720}
    });
    video.srcObject = stream;
    video.onloadedmetadata = () => {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      info.innerText = "ğŸ“¹ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªØ¹Ù…Ù„ â€” Ù‚Ù… Ø¨Ø§Ù„ØªØ­Ø±Ùƒ!";
      loop();
    };
  } catch(e) {
    info.innerText = "âŒ ØªÙ… Ø±ÙØ¶ Ø¥Ø°Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§. Ø§Ø³Ù…Ø­ Ù…Ù† Ø§Ù„Ù‚ÙÙ„ Ø¨Ø¬ÙˆØ§Ø± Ø§Ù„Ø±Ø§Ø¨Ø·.";
  }
}

function loop() {
  animationFrame = requestAnimationFrame(loop);
  if (!landmarker || video.readyState < 2) return;

  const now = performance.now();
  const result = landmarker.detectForVideo(video, now);

  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  if (result.landmarks.length > 0) {
    const lms = result.landmarks[0];
    const hip = lms[23], knee = lms[25], ankle = lms[27];
    const kneeAngle = angle(hip, knee, ankle);

    ctx.fillStyle = "yellow";
    ctx.fillText(`Knee: ${Math.round(kneeAngle)}Â°`, 20, 30);
    ctx.fillText(`Reps: ${reps}`, 20, 60);

    if (kneeAngle < 100) wasDown = true;
    if (kneeAngle > 160 && wasDown) {
      reps++;
      wasDown = false;
    }
  }
}

document.getElementById("btnStart").addEventListener("click", startCamera);

initModel(); 
</script>

</body>
</html>
