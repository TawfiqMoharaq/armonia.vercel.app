<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>كاميرا + تتبّع الوضعيات (Vanilla)</title>

  <!-- ✅ حزمة MediaPipe Vision (بدون imports) -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.22/vision_bundle.js"
          crossorigin="anonymous"></script>

  <style>
    :root { --card:#fff; --border:#e5e7eb; --ink:#0b1320; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Arial;background:#f7f9fb;color:var(--ink)}
    .bar{display:flex;gap:10px;align-items:center;padding:14px 16px}
    button{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#0a6d8b;color:#fff;font-weight:600;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .hint{font-size:13px;color:#445}
    .grid{display:grid;gap:16px;padding:16px;grid-template-columns:1fr}
    @media(min-width:960px){.grid{grid-template-columns:1fr 1fr}}
    .card{position:relative;background:#000;border:1px solid var(--border);border-radius:20px;overflow:hidden;min-height:320px}
    .white{background:#fff}
    video,canvas{display:block;width:100%;height:auto}
    .hud{position:absolute;top:10px;left:10px;color:#fff;background:#0009;padding:8px 12px;border-radius:12px;font-size:14px}
    .error{position:absolute;inset:0;display:none;align-items:center;justify-content:center;color:#fff;background:#000a;padding:16px;text-align:center;white-space:pre-wrap;line-height:1.6}
  </style>
</head>
<body>
  <div class="bar">
    <button id="startBtn">تشغيل الكاميرا</button>
    <button id="stopBtn" disabled>إيقاف</button>
    <span class="hint">مطلوب HTTPS + السماح للكاميرا. لو رفضت من قبل غيّر الإذن من إعدادات الموقع ثم أعد المحاولة.</span>
  </div>

  <div class="grid">
    <div class="card">
      <video id="video" playsinline muted></video>
      <canvas id="canvas"></canvas>

      <div class="hud">Reps: <b id="reps">0</b> | Knee: <span id="kneev">—</span>° | Back: <span id="backv">—</span>°</div>
      <div id="err" class="error"></div>
    </div>

    <div class="card white">
      <img src="/gifs/squat.gif" alt="demo" style="width:100%;height:auto;display:block;object-fit:contain;background:#fff">
    </div>
  </div>

  <!-- ✅ سكربت بعد العناصر وبدون type="module" -->
  <script>
  (function(){
    // تأكد أن حزمة vision جاهزة
    if (!window.vision) {
      alert("تعذر تحميل مكتبة MediaPipe (vision_bundle). تحقق من الشبكة/الإضافات ثم حدّث الصفحة.");
      return;
    }

    const { FilesetResolver, PoseLandmarker } = window.vision;

    const MODEL_URLS = [
      "https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/latest/pose_landmarker_lite.task",
      "https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float32/latest/pose_landmarker_lite.task",
      "https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_full/float32/latest/pose_landmarker_full.task",
    ];
    const WASM_BASE = "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.22/wasm";

    const KNEE_UP = 160, KNEE_DOWN_MIN = 70, KNEE_DOWN_MAX = 100;

    const startBtn = document.getElementById("startBtn");
    const stopBtn  = document.getElementById("stopBtn");
    const video    = document.getElementById("video");
    const canvas   = document.getElementById("canvas");
    const ctx      = canvas.getContext("2d");
    const errBox   = document.getElementById("err");
    const repsEl   = document.getElementById("reps");
    const kneevEl  = document.getElementById("kneev");
    const backvEl  = document.getElementById("backv");

    let landmarker = null, raf = 0, wasDown = false, reps = 0;

    const toDeg = r => (r*180)/Math.PI;
    function ang(a,c,b){
      if(!a||!b||!c) return null;
      const v1=[a.x-c.x,a.y-c.y,a.z-c.z], v2=[b.x-c.x,b.y-c.y,b.z-c.z];
      const dot=v1[0]*v2[0]+v1[1]*v2[1]+v1[2]*v2[2];
      const m1=Math.hypot(...v1), m2=Math.hypot(...v2);
      if(!m1||!m2) return null;
      return toDeg(Math.acos(Math.min(Math.max(dot/(m1*m2),-1),1)));
    }
    const pickLeg=(lms)=> {
      const L={shoulder:11,hip:23,knee:25,ankle:27}, R={shoulder:12,hip:24,knee:26,ankle:28};
      const vis=i=>lms[i]?.visibility??0;
      const s=x=>vis(x.hip)+vis(x.knee)+vis(x.ankle);
      return s(L)>=s(R)?L:R;
    };
    const showError=(m)=>{errBox.style.display="flex";errBox.textContent=String(m||"خطأ غير متوقع")};
    const hideError=()=>{errBox.style.display="none";errBox.textContent=""};

    function syncSize(){
      if (video.videoWidth && video.videoHeight){
        canvas.width = video.videoWidth;
        canvas.height= video.videoHeight;
      }
    }
    function stopAll(){
      cancelAnimationFrame(raf);
      const s=video.srcObject; if(s) s.getTracks().forEach(t=>t.stop());
      video.srcObject=null;
      landmarker?.close?.(); landmarker=null;
      stopBtn.disabled=true; startBtn.disabled=false;
    }

    async function start(){
      try{
        startBtn.disabled = true; hideError(); reps=0; wasDown=false;
        repsEl.textContent = "0"; kneevEl.textContent = "—"; backvEl.textContent = "—";

        if (!navigator.mediaDevices?.getUserMedia) throw new Error("المتصفح لا يدعم getUserMedia.");
        if (!window.isSecureContext) throw new Error("الصفحة ليست HTTPS. استخدم https أو localhost.");

        const fileset = await FilesetResolver.forVisionTasks(WASM_BASE);

        // جرّب Lite/Full بالتسلسل
        let err=null;
        for (const url of MODEL_URLS){
          try{
            landmarker = await PoseLandmarker.createFromOptions(fileset, {
              baseOptions: { modelAssetPath: url },
              runningMode: "VIDEO",
              numPoses: 1
            });
            console.log("[PoseLandmarker] loaded:", url);
            err=null; break;
          }catch(e){ console.warn("model failed:", url, e); err=e; }
        }
        if(!landmarker) throw err||new Error("فشل تحميل نموذج التتبّع.");

        const stream = await navigator.mediaDevices.getUserMedia({ video:{facingMode:"user",width:{ideal:960},height:{ideal:720}}, audio:false });
        video.srcObject = stream;
        video.muted = true; video.playsInline = true;
        await video.play().catch(()=>{});
        if (video.readyState < 2) await new Promise(res => video.onloadeddata = res);

        syncSize();
        video.addEventListener("loadedmetadata", syncSize);
        video.addEventListener("resize", syncSize);

        stopBtn.disabled = false;
        loop();
      }catch(e){
        console.error(e);
        showError(e.message||e);
        startBtn.disabled=false; stopBtn.disabled=true;
      }
    }

    function loop(){
      if (!landmarker) return;
      const t = performance.now();
      const out = landmarker.detectForVideo(video, t);

      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(video,0,0,canvas.width,canvas.height);

      if (out.landmarks.length){
        const lms = out.landmarks[0];
        const side = pickLeg(lms);
        const hip=lms[side.hip], knee=lms[side.knee], ankle=lms[side.ankle], shoulder=lms[side.shoulder];

        const kneeA = ang(hip,knee,ankle);
        const backA = ang(shoulder,hip,knee);

        if (kneeA!=null){
          const k=Math.round(kneeA);
          kneevEl.textContent=k;
          if (k<=KNEE_DOWN_MAX && k>=KNEE_DOWN_MIN) wasDown=true;
          if (k>=KNEE_UP && wasDown){ wasDown=false; reps++; repsEl.textContent=String(reps); }
        } else { kneevEl.textContent="—"; }

        backvEl.textContent = backA!=null ? Math.round(backA) : "—";
      }

      raf = requestAnimationFrame(loop);
    }

    startBtn.addEventListener("click", start);
    stopBtn .addEventListener("click", stopAll);
    window.addEventListener("beforeunload", stopAll);
  })();
  </script>
</body>
</html>
