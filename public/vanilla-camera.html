<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Camera Diagnostics</title>
<style>
  :root{--w:min(1120px,94vw);}
  body{margin:0;background:#0e0e0e;color:#fff;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  header,main{width:var(--w);margin:16px auto}
  .row{display:flex;gap:14px;flex-wrap:wrap;align-items:center}
  select,button{padding:10px 12px;border-radius:10px;border:0;background:#1f1f1f;color:#fff}
  button.primary{background:#0a84ff}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .card{background:#000;border-radius:18px;overflow:hidden;position:relative;min-height:380px}
  video,canvas{width:100%;height:100%;display:block;object-fit:contain;background:#000}
  .hud{position:absolute;top:10px;left:10px;padding:8px 10px;background:rgb(0 0 0 /.4);border-radius:10px;font:12px monospace}
  .warn{position:absolute;bottom:12px;left:50%;transform:translateX(-50%);background:#e11d48;padding:8px 12px;border-radius:12px;display:none}
  .log{white-space:pre-wrap;font:12px monospace;opacity:.9}
</style>
</head>
<body>
  <header>
    <div class="row">
      <button id="btnStart" class="primary">تشغيل الكاميرا</button>
      <button id="btnStop">إيقاف</button>
      <button id="btnSwitch">بدّل الكاميرا</button>
      <label>اختر الكاميرا:
        <select id="selCams"></select>
      </label>
      <span id="status">جاهز</span>
    </div>
  </header>

  <main class="grid">
    <div class="card">
      <video id="video" autoplay playsinline muted></video>
      <div class="hud" id="hudVid"></div>
    </div>
    <div class="card">
      <canvas id="canvas"></canvas>
      <div class="hud" id="hudCan"></div>
      <div class="warn" id="warn">لا توجد فريمات صالحة للرسم</div>
    </div>
  </main>

  <section style="width:var(--w);margin:0 auto 28px">
    <h3>سجل تشخيص</h3>
    <div class="log" id="log"></div>
  </section>

<script>
const statusEl = document.getElementById('status');
const selCams  = document.getElementById('selCams');
const btnStart = document.getElementById('btnStart');
const btnStop  = document.getElementById('btnStop');
const btnSwitch= document.getElementById('btnSwitch');
const video    = document.getElementById('video');
const canvas   = document.getElementById('canvas');
const ctx      = canvas.getContext('2d');
const hudVid   = document.getElementById('hudVid');
const hudCan   = document.getElementById('hudCan');
const warn     = document.getElementById('warn');
const logEl    = document.getElementById('log');

let stream=null, raf=0, cams=[], cur=0, lastT=0, frames=0;

function log(s){ console.log(s); logEl.textContent = (s+"\n"+logEl.textContent).slice(0,8000); }
function setStatus(s){ statusEl.textContent=s }

async function listCams(){
  const devs = await navigator.mediaDevices.enumerateDevices();
  cams = devs.filter(d=>d.kind==='videoinput');
  selCams.innerHTML = '';
  cams.forEach((c,i)=>{
    const o=document.createElement('option');
    o.value=i; o.textContent = c.label || `Camera ${i+1}`;
    selCams.appendChild(o);
  });
  if(cams.length===0) throw new Error('لا توجد كاميرات.');
  selCams.value = cur;
}

function stop(){
  cancelAnimationFrame(raf); raf=0;
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null }
  ctx.clearRect(0,0,canvas.width,canvas.height);
  setStatus('تم الإيقاف');
}

function syncCanvas(){
  if(video.videoWidth>0 && video.videoHeight>0){
    if(canvas.width!==video.videoWidth) canvas.width = video.videoWidth;
    if(canvas.height!==video.videoHeight) canvas.height = video.videoHeight;
  }
}

async function start(){
  try{
    setStatus('طلب الإذن…');
    await listCams();

    const picked = cams[cur];
    const tries = [
      {video:{deviceId:picked?.deviceId, width:{ideal:1280}, height:{ideal:720}, facingMode:'user'}},
      {video:{deviceId:picked?.deviceId, width:{min:640}, height:{min:480}}},
      {video:true}
    ];

    let lastErr=null;
    for(const c of tries){
      try{ stream = await navigator.mediaDevices.getUserMedia(c); break; }
      catch(e){ lastErr=e; log('getUserMedia failed: '+e.name) }
    }
    if(!stream) throw lastErr || new Error('تعذّر فتح الكاميرا');

    video.srcObject = stream;

    await video.play().catch(()=>{});
    if(video.readyState<2 || video.videoWidth===0){
      await new Promise(res => video.addEventListener('loadeddata', res, {once:true}));
    }

    syncCanvas();
    frames=0; lastT=performance.now();
    setStatus('تشغيل — اختر كاميرا إن كانت سوداء');

    loop();
  }catch(e){
    log('start() error: '+(e.name||e.message||e));
    setStatus('خطأ: '+(e.name||e.message||e));
  }
}

function loop(){
  raf=requestAnimationFrame(loop);
  if(video.readyState<2){ return; }

  syncCanvas();

  // ارسم الفيديو الخام (مرآة)
  ctx.save();
  ctx.scale(-1,1);
  ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
  ctx.restore();

  // HUD للفيديو
  frames++;
  const now=performance.now();
  if(now-lastT>1000){
    const fps=Math.round(frames*1000/(now-lastT));
    frames=0; lastT=now;
    hudVid.textContent = `readyState=${video.readyState} | vw=${video.videoWidth} vh=${video.videoHeight} | FPS~${fps}`;
  }

  // لو الإطار أسود بالكامل تقريبًا (فحص بسيط)
  const px = ctx.getImageData(10,10,1,1).data;
  const dark = (px[0]+px[1]+px[2])<10;
  warn.style.display = dark ? 'block' : 'none';
  hudCan.textContent = dark ? 'canvas: dark frame' : 'canvas: ok';
}

btnStart.onclick = start;
btnStop.onclick  = stop;
btnSwitch.onclick = async ()=>{
  try{
    await listCams();
    cur = (cur+1)%cams.length;
    selCams.value = cur;
    stop();
    await start();
  }catch(e){ log('switch error: '+(e.name||e.message||e)) }
};
selCams.onchange = async e=>{
  cur = +e.target.value;
  stop(); await start();
};

// ملاحظات سريعة
log(`Navigator: ${navigator.userAgent}`);
log(`isSecureContext=${isSecureContext}`);
navigator.permissions?.query({name:'camera'}).then(p=>log('permission.camera='+p.state)).catch(()=>{});
</script>
</body>
</html>
