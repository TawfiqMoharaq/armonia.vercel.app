<script>
let video = document.getElementById("video");
let canvas = document.getElementById("canvas");
let ctx = canvas.getContext("2d");
let info = document.getElementById("info");
let landmarker = null;
let rafId = 0;
let reps = 0;
let wasDown = false;

const WASM_BASE = "https://unpkg.com/@mediapipe/tasks-vision@0.10.22/wasm";
const KNEE_UP = 160, KNEE_DOWN_MIN = 70, KNEE_DOWN_MAX = 100;

// 2D angle
function angle(a, b, c) {
  if (!a || !b || !c) return null;
  const abx = a.x - b.x, aby = a.y - b.y;
  const cbx = c.x - b.x, cby = c.y - b.y;
  const dot = abx*cbx + aby*cby;
  const mab = Math.hypot(abx, aby);
  const mcb = Math.hypot(cbx, cby);
  if (!mab || !mcb) return null;
  const cos = Math.min(Math.max(dot / (mab*mcb), -1), 1);
  return Math.acos(cos) * 180 / Math.PI;
}

function pickLeg(lms){
  // indices من Mediapipe: L(11,23,25,27) R(12,24,26,28)
  const L={shoulder:11,hip:23,knee:25,ankle:27}, R={shoulder:12,hip:24,knee:26,ankle:28};
  const vis = i => lms[i]?.visibility ?? 0;
  const score = side => (vis(side.hip) + vis(side.knee) + vis(side.ankle));
  return score(L) >= score(R) ? L : R;
}

function syncCanvasSize(){
  // لو بعد التشغيل تغيرت أبعاد الفيديو (بعض الأجهزة تفعلها) نزبط الكانفس
  const w = video.videoWidth || 640;
  const h = video.videoHeight || 480;
  if (canvas.width !== w) canvas.width = w;
  if (canvas.height !== h) canvas.height = h;
}

async function initModel(){
  info.textContent = "جارٍ تحميل نموذج تتبّع الجسم…";
  const fileset = await FilesetResolver.forVisionTasks(WASM_BASE);
  landmarker = await PoseLandmarker.createFromOptions(fileset, {
    baseOptions: { modelAssetPath:
      "https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/latest/pose_landmarker_lite.task"
    },
    runningMode: "VIDEO",
    numPoses: 1
  });
  info.textContent = "✅ تم تحميل النموذج — اضغط تشغيل الكاميرا";
}

async function startCamera(){
  info.textContent = "طلب إذن الكاميرا…";
  try{
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "user", width: {ideal: 1280}, height: {ideal: 720} },
      audio: false
    });
    video.srcObject = stream;
    video.onloadedmetadata = () => {
      syncCanvasSize();
      info.textContent = "الكاميرا تعمل — تم بالتتبّع! 📷";
      video.play();
      // اسمع أي تغيير أبعاد يحدث لاحقًا
      video.addEventListener("resize", syncCanvasSize);
      loop();
    };
  }catch(e){
    info.textContent = "❌ رُفض إذن الكاميرا. اسمح من القفل بجوار الرابط ثم حدّث الصفحة.";
  }
}

function drawLandmarks(lms){
  // نقاط
  ctx.fillStyle = "#18A4B8";
  for (const p of lms){
    if ((p.visibility ?? 0) > 0.55) {
      ctx.beginPath();
      ctx.arc(p.x * canvas.width, p.y * canvas.height, 4, 0, Math.PI*2);
      ctx.fill();
    }
  }
}

function loop(){
  rafId = requestAnimationFrame(loop);
  if (!landmarker || video.readyState < 2) return;

  // 1) ارسم الفيديو أولًا (مع قلب أفقي لعرض Selfie)
  syncCanvasSize();
  ctx.save();
  ctx.scale(-1, 1);                      // mirror
  ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
  ctx.restore();

  // 2) التتبّع
  const now = performance.now();
  const out = landmarker.detectForVideo(video, now);

  // 3) لو فيه نقاط، ارسمها واحسب الزوايا والعدّ
  if (out.landmarks.length){
    const lmsNorm = out.landmarks[0];

    // نقاط lmsNorm.x/y هي normalized (0..1) — حوّلها لإحداثيات بكسلية عند الرسم
    drawLandmarks(lmsNorm);

    const side = pickLeg(lmsNorm);
    const hip = lmsNorm[side.hip], knee = lmsNorm[side.knee], ankle = lmsNorm[side.ankle];

    const kAng = angle(
      {x: hip.x, y: hip.y},
      {x: knee.x, y: knee.y},
      {x: ankle.x, y: ankle.y}
    );

    // نصوص تشخيصية
    ctx.fillStyle = "white";
    ctx.font = "16px sans-serif";
    ctx.fillText(`Knee: ${kAng ? Math.round(kAng) : "—"}°`, 16, 28);
    ctx.fillText(`Reps: ${reps}`, 16, 50);

    // عدّ السكوات
    if (kAng != null) {
      if (kAng <= KNEE_DOWN_MAX) wasDown = true;
      if (kAng >= KNEE_UP && wasDown) {
        reps++;
        wasDown = false;
      }
    }
  } else {
    // لو ما تعرف على جسم، أعرض تلميح
    ctx.fillStyle = "white";
    ctx.font = "16px sans-serif";
    ctx.fillText("اقترب من الكاميرا ووفّر إضاءة أفضل.", 16, 28);
  }
}

document.getElementById("btnStart").addEventListener("click", startCamera);
initModel();
</script>
