<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Armonia – كاميرا + GIF</title>
  <style>
    :root{
      --card-h:460px; --max-w:1100px; --gap:16px; --bg:#111; --fg:#fff; --accent:#0a84ff;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;min-height:100vh}
    header{display:flex;justify-content:space-between;align-items:center;width:min(92vw,var(--max-w));margin:18px auto 0;gap:10px}
    .btn{border:0;padding:10px 14px;border-radius:12px;color:#fff;background:var(--accent);font-weight:700;cursor:pointer}
    .btn.secondary{background:#444}
    .btn.ghost{background:#2b2b2b}
    #info{font-size:14px;opacity:.9}
    #container{width:min(92vw,var(--max-w));margin:12px auto 24px;display:grid;grid-template-columns:1fr 1fr;gap:var(--gap)}
    .card{width:100%;height:var(--card-h);background:#000;border-radius:20px;overflow:hidden;position:relative;box-shadow:0 10px 30px rgb(0 0 0 / 25%)}
    #demo{width:100%;height:100%;object-fit:contain;background:#000;display:block}
    #video{display:none} /* نخفي الفيديو عادةً */
    #canvas{width:100%;height:100%;display:block;background:#000}
    .hud{position:absolute;top:10px;right:12px;display:flex;gap:8px;padding:6px 10px;background:rgb(0 0 0 / .45);border-radius:10px;font-size:13px;backdrop-filter:blur(4px)}
    .hud b{font-weight:700}
    .warning{position:absolute;left:50%;transform:translateX(-50%);bottom:12px;padding:8px 14px;border-radius:14px;background:rgba(220,38,38,.88);color:#fff;font-weight:700;box-shadow:0 8px 20px rgba(0,0,0,.35);display:none}
    .debug{position:absolute;left:10px;top:10px;font:12px monospace;background:rgb(0 0 0 / .5);padding:4px 8px;border-radius:8px}
    @media (max-width:900px){#container{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <div id="info">جاهز ✅ — شغّل الكاميرا للتتبّع</div>
    <div style="display:flex;gap:8px">
      <button id="btnCycle" class="btn ghost" title="بدّل بين الكاميرات">بدّل الكاميرا</button>
      <button id="btnStart" class="btn">تشغيل الكاميرا</button>
      <button id="btnStop" class="btn secondary" style="display:none">إيقاف</button>
    </div>
  </header>

  <main id="container">
    <!-- يسار: GIF -->
    <div class="card">
      <img id="demo" src="/gifs/squat.gif" alt="Bodyweight Squat GIF" onerror="this.style.display='none'"/>
    </div>

    <!-- يمين: كاميرا -->
    <div class="card">
      <video id="video" autoplay playsinline muted></video>
      <canvas id="canvas"></canvas>

      <div class="hud" id="hud" style="display:none">
        <span>Reps: <b id="reps">0</b></span>
        <span>| Knee: <b id="knee">—</b>°</span>
        <span>| Back: <b id="back">—</b>°</span>
      </div>
      <div class="warning" id="warn">حافظ على استقامة ظهرك!</div>
      <div class="debug" id="dbg" style="display:none"></div>
    </div>
  </main>

  <!-- Mediapipe Vision bundle -->
  <script src="https://unpkg.com/@mediapipe/tasks-vision@0.10.22/vision_bundle.js"
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script>
    const infoEl=document.getElementById('info');
    const btnStart=document.getElementById('btnStart');
    const btnStop=document.getElementById('btnStop');
    const btnCycle=document.getElementById('btnCycle');
    const video=document.getElementById('video');
    const canvas=document.getElementById('canvas');
    const ctx=canvas.getContext('2d');
    const hud=document.getElementById('hud');
    const repsEl=document.getElementById('reps');
    const kneeEl=document.getElementById('knee');
    const backEl=document.getElementById('back');
    const warnEl=document.getElementById('warn');
    const dbg=document.getElementById('dbg');

    let landmarker=null, rafId=0, stream=null;
    let cams=[], camIndex=0;

    // عدّ السكوات
    let reps=0, wasDown=false;
    const KNEE_UP=160, KNEE_DOWN_MIN=70, KNEE_DOWN_MAX=100, BACK_SAFE=150;

    function setInfo(t){ infoEl.textContent=t }
    function logDebug(t){ dbg.style.display='block'; dbg.textContent=t }

    function angle(a,b,c){
      if(!a||!b||!c) return null;
      const abx=a.x-b.x, aby=a.y-b.y, cbx=c.x-b.x, cby=c.y-b.y;
      const dot=abx*cbx+aby*cby, mab=Math.hypot(abx,aby), mcb=Math.hypot(cbx,cby);
      if(!mab||!mcb) return null;
      const cos=Math.min(Math.max(dot/(mab*mcb),-1),1);
      return Math.acos(cos)*180/Math.PI;
    }
    function pickLeg(lms){
      const L={shoulder:11,hip:23,knee:25,ankle:27}, R={shoulder:12,hip:24,knee:26,ankle:28};
      const vis=i=>lms[i]?.visibility??0, score=s=>vis(s.hip)+vis(s.knee)+vis(s.ankle);
      return score(L)>=score(R)?L:R;
    }
    function syncCanvas(){
      if(!video.videoWidth||!video.videoHeight) return;
      if(canvas.width!==video.videoWidth) canvas.width=video.videoWidth;
      if(canvas.height!==video.videoHeight) canvas.height=video.videoHeight;
    }

    async function ensureModel(){
      try{
        setInfo("جارٍ تحميل نموذج Mediapipe…");
        const fileset=await FilesetResolver.forVisionTasks("https://unpkg.com/@mediapipe/tasks-vision@0.10.22/wasm");
        landmarker=await PoseLandmarker.createFromOptions(fileset,{
          baseOptions:{ modelAssetPath:"https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/latest/pose_landmarker_lite.task" },
          runningMode:"VIDEO", numPoses:1
        });
        setInfo("✅ النموذج جاهز — اختر كاميرا وشغّل");
      }catch(e){
        console.error(e);
        setInfo("❌ فشل تحميل نموذج Mediapipe. تحقق من الشبكة ثم حدّث الصفحة.");
      }
    }

    async function listCameras(){
      const devs=await navigator.mediaDevices.enumerateDevices();
      cams=devs.filter(d=>d.kind==="videoinput");
      if(cams.length===0) throw new Error("لا توجد كاميرات متاحة.");
      // حاول استرجاع آخر كاميرا استخدمت
      const saved=localStorage.getItem("armonia_cam_id");
      const idx=Math.max(0, cams.findIndex(d=>d.deviceId===saved));
      camIndex=idx===-1?0:idx;
    }

    function stopStream(){
      if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null }
    }

    async function getStreamForIndex(index){
      const dev=cams[index];
      // ثلاث محاولات قيود متدرجة
      const tries=[
        {video:{deviceId: dev?.deviceId, width:{ideal:1280}, height:{ideal:720}, facingMode:{ideal:"user"}}},
        {video:{deviceId: dev?.deviceId, width:{min:640}, height:{min:480}}},
        {video:true}
      ];
      let lastErr=null;
      for(const c of tries){
        try{ return await navigator.mediaDevices.getUserMedia(c) }
        catch(e){ lastErr=e }
      }
      throw lastErr||new Error("تعذّر فتح الكاميرا المحددة.");
    }

    async function startCamera(){
      try{
        if(!landmarker) await ensureModel();
        await listCameras();

        setInfo("طلب إذن الكاميرا…");
        stopStream();
        stream=await getStreamForIndex(camIndex);
        video.srcObject=stream;

        // انتظر حتى تُحمّل بيانات الفيديو فعليًا
        await video.play().catch(()=>{});
        await new Promise(res=>{
          if(video.readyState>=2 && video.videoWidth>0) res();
          else video.addEventListener("loadeddata", ()=>res(), {once:true});
        });

        // خزّن الكاميرا المختارة
        const dev=cams[camIndex];
        if(dev?.deviceId) localStorage.setItem("armonia_cam_id", dev.deviceId);

        syncCanvas();

        reps=0; wasDown=false;
        repsEl.textContent='0'; kneeEl.textContent='—'; backEl.textContent='—';

        btnStart.style.display='none';
        btnStop.style.display='inline-block';

        // ابدأ الحلقة
        drawLoop();

        setInfo("📹 الكاميرا تعمل — تم بالتتبّع!");
      }catch(e){
        console.error(e);
        setInfo("❌ تعذّر تشغيل الكاميرا: "+(e?.name||e?.message||e));
      }
    }

    function drawLoop(){
      rafId=requestAnimationFrame(drawLoop);
      if(!landmarker || video.readyState<2) return;

      syncCanvas();

      // لو ما زال المقاس صفر لا نرسم
      if(canvas.width===0||canvas.height===0) return;

      // ارسم الفيديو (مرآة للـ selfie)
      ctx.save();
      ctx.scale(-1,1);
      ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
      ctx.restore();

      // أحيانًا تتجمّد الفريمات — أجبر التشغيل
      if(video.paused || video.ended) video.play().catch(()=>{});

      const now=performance.now();
      const out=landmarker.detectForVideo(video, now);

      if(out.landmarks.length){
        hud.style.display='flex'; warnEl.style.display='none'; dbg.style.display='none';

        const lms=out.landmarks[0];
        ctx.fillStyle="#18A4B8";
        for(const p of lms){
          if((p.visibility??0)>0.55){
            ctx.beginPath(); ctx.arc(p.x*canvas.width, p.y*canvas.height, 4, 0, Math.PI*2); ctx.fill();
          }
        }

        const side=(()=>{ // اختَر الساق الأقوى
          const L={shoulder:11,hip:23,knee:25,ankle:27}, R={shoulder:12,hip:24,knee:26,ankle:28};
          const vis=i=>lms[i]?.visibility??0, score=s=>vis(s.hip)+vis(s.knee)+vis(s.ankle);
          return score(L)>=score(R)?L:R;
        })();

        const hip=lms[side.hip], knee=lms[side.knee], ankle=lms[side.ankle], shoulder=lms[side.shoulder];
        const kneeAng=angle(hip,knee,ankle), backAng=angle(shoulder,hip,knee);

        if(kneeAng!=null){
          const r=Math.round(kneeAng); kneeEl.textContent=r;
          if(r>=KNEE_DOWN_MIN && r<=KNEE_DOWN_MAX) wasDown=true;
          if(r>=KNEE_UP && wasDown){ wasDown=false; reps++; repsEl.textContent=reps }
        }else{ kneeEl.textContent='—' }

        if(backAng!=null){
          const r=Math.round(backAng); backEl.textContent=r;
          warnEl.style.display = r<BACK_SAFE ? 'block' : 'none';
        }else{ backEl.textContent='—'; warnEl.style.display='none' }

      }else{
        hud.style.display='none';
        warnEl.style.display='none';
        logDebug(`no landmarks | readyState=${video.readyState} vw=${video.videoWidth} vh=${video.videoHeight}`);
      }
    }

    function stopCamera(){
      cancelAnimationFrame(rafId); rafId=0;
      stopStream();
      hud.style.display='none'; warnEl.style.display='none'; dbg.style.display='none';
      btnStart.style.display='inline-block'; btnStop.style.display='none';
      ctx.clearRect(0,0,canvas.width,canvas.height);
      setInfo("تم إيقاف الكاميرا. يمكنك تشغيلها مجددًا.");
    }

    async function cycleCamera(){
      try{
        await listCameras();
        if(cams.length<=1){
          setInfo("لا توجد إلا كاميرا واحدة.");
          return;
        }
        camIndex = (camIndex+1) % cams.length;
        setInfo("التبديل إلى كاميرا أخرى…");
        await startCamera();
      }catch(e){
        console.error(e);
        setInfo("تعذّر التبديل بين الكاميرات: "+(e?.message||e));
      }
    }

    btnStart.addEventListener('click', startCamera);
    btnStop .addEventListener('click', stopCamera);
    btnCycle.addEventListener('click', cycleCamera);

    // حمّل النموذج مباشرة
    ensureModel();

    // نصيحة: أغلق كل تبويبات الموقع الأخرى التي قد تكون ماسكة الكاميرا.
  </script>
</body>
</html>
