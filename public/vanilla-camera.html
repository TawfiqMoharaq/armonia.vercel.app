<script>
  const { FilesetResolver, PoseLandmarker, DrawingUtils } = window.vision;

  const MODEL_URL = "https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/latest/pose_landmarker_lite.task";
  const WASM_BASE = "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.22/wasm";

  const startBtn = document.getElementById("startBtn");
  const stopBtn  = document.getElementById("stopBtn");
  const video    = document.getElementById("video");
  const canvas   = document.getElementById("canvas");
  const ctx      = canvas.getContext("2d");
  const errBox   = document.getElementById("err");
  const repsEl   = document.getElementById("reps");
  const kneeEl   = document.getElementById("knee");
  const backEl   = document.getElementById("back");

  let landmarker = null;
  let raf = 0;
  let wasDown = false;
  let reps = 0;

  function toDeg(r) { return (r * 180) / Math.PI; }
  function angle(a,c,b) {
    if (!a||!b||!c) return null;
    const v1 = [a.x-c.x, a.y-c.y, a.z-c.z];
    const v2 = [b.x-c.x, b.y-c.y, b.z-c.z];
    const dot = v1[0]*v2[0] + v1[1]*v2[1] + v1[2]*v2[2];
    const m1 = Math.hypot(...v1), m2 = Math.hypot(...v2);
    if (!m1 || !m2) return null;
    return toDeg(Math.acos(Math.min(Math.max(dot/(m1*m2),-1),1)));
  }

  async function startCamera() {
    startBtn.disabled = true;
    errBox.style.display = "none";
    reps = 0; wasDown = false;

    try {
      const fileset = await FilesetResolver.forVisionTasks(WASM_BASE);
      landmarker = await PoseLandmarker.createFromOptions(fileset, {
        baseOptions: { modelAssetPath: MODEL_URL },
        runningMode: "VIDEO",
        numPoses: 1,
      });

      const stream = await navigator.mediaDevices.getUserMedia({ video:true });
      video.srcObject = stream;
      await video.play();

      loop();
      stopBtn.disabled = false;
    } catch (e) {
      errBox.textContent = e.message;
      errBox.style.display = "flex";
      startBtn.disabled = false;
    }
  }

  function loop() {
    const now = performance.now();
    const result = landmarker.detectForVideo(video, now);

    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    if (result.landmarks.length) {
      const [lms] = result.landmarks;
      const leg = { shoulder:11, hip:23, knee:25, ankle:27 };

      const k = angle(lms[leg.hip], lms[leg.knee], lms[leg.ankle]);
      if (k != null) {
        const kv = Math.round(k);
        kneeEl.textContent = kv;
        if (kv > 160 && wasDown) {
          wasDown = false;
          reps++;
          repsEl.textContent = reps;
        }
        if (kv < 100) wasDown = true;
      }

      const b = angle(lms[leg.shoulder], lms[leg.hip], lms[leg.knee]);
      backEl.textContent = b != null ? Math.round(b) : "â€”";
    }

    raf = requestAnimationFrame(loop);
  }

  function stopCamera() {
    cancelAnimationFrame(raf);
    const s = video.srcObject;
    if (s) s.getTracks().forEach(t => t.stop());
    landmarker?.close?.();
    stopBtn.disabled = true;
    startBtn.disabled = false;
  }

  startBtn.onclick = startCamera;
  stopBtn.onclick = stopCamera;
</script>
